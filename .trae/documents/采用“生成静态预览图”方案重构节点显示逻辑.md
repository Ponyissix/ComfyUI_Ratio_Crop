# 重构：模仿 ComfyUI 原生遮罩编辑器

非常抱歉之前的尝试没有达到预期。你提到的“像 ComfyUI 自带的遮罩编辑器”是一个非常好的思路。ComfyUI 的 `LoadImage` 节点实际上并没有直接支持“编辑后刷新缩略图显示遮罩”的功能，但 `MaskEditor` 确实是弹窗编辑并保存。

既然之前的“自定义绘制 Canvas”方案因为 ComfyUI 的刷新机制导致显示不稳定，我们换一种**最原生、最稳妥**的思路：

## 新方案核心逻辑

1.  **放弃自定义 Canvas 绘图**：
    *   不再试图在节点上用 `ctx.drawImage` 画复杂的框和遮罩。
    *   **回归本质**：节点只负责显示图片（让 ComfyUI 自己去画）。

2.  **利用“临时预览图”机制**：
    *   当你在弹窗编辑器里点击“保存”时，我们不仅更新参数，还**生成一张带绿框的预览图**（在前端生成）。
    *   将这张图**替换**掉节点原本显示的图片。
    *   这样，节点显示的永远是一张静态的、已经画好框的图片。ComfyUI 把它当成普通图片显示，绝对不会有 Bug。

3.  **流程**：
    *   **加载**：节点显示原图。
    *   **点击编辑**：弹出全屏编辑器（这是目前唯一工作正常的部分）。
    *   **保存**：
        1.  更新 `crop_x, crop_y` 等参数。
        2.  **关键步骤**：在 JS 里创建一个临时的 Canvas，把原图画上去，把绿框画上去，生成一个 Base64 或 Blob。
        3.  强制将这个新的“带框图”设置为节点的预览图。

这样，节点上显示的就是一张**真正带有绿框的图片**，而不是靠代码实时画上去的。这能保证 100% 显示成功。

请确认是否采用此“生成静态预览图”的方案。