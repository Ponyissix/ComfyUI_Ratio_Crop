# 终极修复方案：消除预览与实际输出的不一致

**现状分析**：
用户截图显示：
1.  **UI 面板数字**：`crop_w = 977`, `crop_h = 1536`。
2.  **中间预览图**：`864 x 1536`（正确的 9:16）。
3.  **左侧绿框预览**：看起来很宽（应该是 977 宽），且明显比 864 宽。

**核心矛盾**：
尽管我已经添加了 `ui.widget_values` 返回值试图更新 UI，但截图显示 UI **并没有更新**（依然是 977 而不是 864）。
这说明 ComfyUI 的前端可能并没有处理 `widget_values` 更新，或者更新失败。
更糟糕的是，左侧的绿框预览图（`preview_pil`）依然是基于 `977` 绘制的，而不是基于 `864` 绘制的。

**为什么绿框是错的？**
我在 `nodes.py` 中写了：
```python
            ui_update_values = [..., int(first_res[7]), ...] # first_res[7] 是 w
```
而 `first_res` 来自 `core_crop_logic` 的返回值。
`core_crop_logic` 内部调用了 `apply_ratio_logic`，应该把 `w` 变成了 864。
**如果 `w` 变成了 864，那绿框（基于 `w` 绘制）应该是 864，UI 更新值也应该是 864。**
**但现在它们都是 977！**

**唯一解释：`core_crop_logic` 并没有成功修改 `w`！**
也就是说，`apply_ratio_logic` 返回了原始的 977，没有变成 864。

**为什么 `apply_ratio_logic` 会失效？**
```python
def apply_ratio_logic(..., ratio):
    if ratio == "Free": return ...
    ...
```
调用处：
```python
    if ratio != "Free":
        ... = apply_ratio_logic(..., ratio)
```
截图显示 `ratio` 是 `Smart`。
在 `apply_ratio_logic` 中：
```python
    if ratio == "Smart":
        current_r = bw / bh # 977 / 1536 = 0.636
        # Find closest standard ratio
        # 9:16 = 0.5625 (diff 0.07)
        # 3:4 = 0.75 (diff 0.11)
        # Smart should detect 9:16.
```
如果检测到了 9:16。
`max_k = 1536 // 16 = 96`。
`k = bw / rw = 977 / 9 = 108`。
`k` 被 `max_k` 限制为 96。
`final_w = 96 * 9 = 864`。

**逻辑在本地测试脚本里跑通了，但在 ComfyUI 里失效了。**
**这通常意味着：传入的 `ratio` 根本不是 "Smart"！**
或者，`ratio` 参数在传递过程中丢失了？
或者，前端传过来的 `ratio` 是 `Smart`（UI 显示），但后端收到的是别的？

**让我们看截图的一个细节：**
用户连接了 `image_input`（蓝色线）。
当连接了 `image_input` 时，`RatioCropNode.crop` 会进入批量处理循环。
```python
        if image_input is not None:
            for i in range(image_input.shape[0]):
                ...
                res = core_crop_logic(..., ratio=ratio)
```
这里的 `ratio` 是函数的参数。
函数参数来自 ComfyUI 的输入。
`ratio` 是一个 Combo（下拉菜单）。
ComfyUI 传递给后端的是字符串。

**有没有可能，用户的 `Smart` 后面有空格？或者大小写？**
代码里写的是 `["Smart", ...]`。应该没问题。

**那还有什么可能？**
**我知道了！**
**`core_crop_logic` 里的 `apply_ratio_logic` 调用是在 `if ratio != "Free":` 块里。**
**但是，`apply_ratio_logic` 内部对于 "Smart" 的处理依赖于 `bw` 和 `bh`。**
在 `core_crop_logic` 里，传入的 `crop_w` 是 977。
`apply_ratio_logic` 应该能算出 864。

**让我们再次检查 `nodes.py` 的代码（通过 Read）。**
**我怀疑之前的 SearchReplace 没有生效，或者生效位置不对。**
**我要读取整个 `nodes.py` 来确认代码逻辑是否真的存在。**

如果代码确实存在且逻辑正确，那么唯一的解释是：**ComfyUI 的缓存机制导致代码没更新**，或者**用户没有重启 ComfyUI**。
但用户既然能看到我之前的“绿框宽了”的修复（虽然他觉得还是不对），说明代码更新了。

**等等！截图里的绿框是 977（宽框）。**
**中间预览图是 864（窄图）。**
这说明 `core_crop_logic` **确实** 裁切出了 864 的图。
**但是**，它返回给预览绘制的 `w` 却是 977。
**这在逻辑上是矛盾的！**
`core_crop_logic`：
```python
    if ratio != "Free":
        crop_w = 864
    w = int(crop_w) # w = 864
    image.crop(..., w, ...) # 裁切 864
    return (..., w, ...) # 返回 864
```
如果返回 864，绿框就是 864。
如果裁切是 864，中间图就是 864。
**现在中间图是 864（对的）。绿框是 977（错的）。**
**这意味着：返回的 `w` 是 977，但裁切用的 `w` 是 864！**
**这怎么可能？**
**除非 `core_crop_logic` 里有两个 `w`！**
或者 `w` 在裁切后被改回去了？

**让我仔细看 Read 出来的代码！**
```python
    if ratio != "Free":
        crop_x, crop_y, crop_w, crop_h = apply_ratio_logic(...)
    
    # 边界检查
    x = max(0, int(round(crop_x)))
    # ...
    w = int(round(crop_w))
```
这没问题。

**有没有可能，`image_tensor` 是对的，但 `crop_data` 是错的？**
`crop_data` 是字典。
```python
    crop_data = { "crop_w": w, ... }
```
`w` 是局部变量。

**这绝对是灵异事件。**
**除非... 预览绘制用的不是 `batch_results`？**
不，代码里就是 `batch_results`。

**等等！**
**我在 `RatioCropNode.crop` 里做了这个修改：**
```python
            # Override with final_w/h/x/y if we are sure
            if image_input.shape[0] == 1:
                 bx, by, bw, bh = final_x, final_y, final_w, final_h
```
这个 `final_w` 是在循环里计算的。
在循环里：
```python
                if ratio != "Free":
                    final_x, final_y, final_w, final_h = apply_ratio_logic(...)
```
所以 `final_w` 应该是 864。
那 `bw` 就应该是 864。
那绿框就应该是 864。

**为什么用户看到的是 977 的绿框？**
**除非... `image_input.shape[0] != 1`？**
用户只连了一张图。shape[0] 应该是 1。

**或者... `ratio` 在 `RatioCropNode` 里是 `Free`？**
如果 `ratio` 是 `Free`。
`apply_ratio_logic` 不执行。
`final_w` 保持 977。
`core_crop_logic` 里 `apply_ratio_logic` 也不执行（因为传入的 ratio 也是 Free）。
那裁切结果应该是 977。
**但中间预览图是 864！**
**这意味着 `core_crop_logic` 里的 `ratio` 不是 Free！**
**但 `RatioCropNode` 里的 `ratio` 是 Free？**
这怎么可能？它们是同一个变量。

**唯一的解释：前端显示的 "Smart" 和后端收到的 "Smart" 是一样的。**
**但是！**
**ComfyUI 的节点执行顺序！**
如果 `image_input` 是 Batch（比如之前运行过一次），现在变成了 Single。
不，这不影响。

**让我再次审视截图。**
绿框确实比中间的图宽。
绿框包含了红色 Mask。红色 Mask 填满了绿框。
中间的图切掉了 Mask 的一部分。
这说明：**绿框对应的区域确实比实际裁切的区域大。**

**结论：**
1.  **实际裁切**用了 864。
2.  **绿框绘制**用了 977。

**这说明 `RatioCropNode.crop` 里的 `final_w` 是 977！**
如果 `final_w` 是 977。
那 `apply_ratio_logic` 在 `RatioCropNode` 里没有生效！
**为什么？**
`if ratio != "Free":`
难道 `ratio` 是 "Free"？
但 UI 显示 "Smart"。

**有没有可能 `ratio` 被覆盖了？**
没有代码覆盖它。

**或者 `apply_ratio_logic` 返回了 977？**
如果 `ratio` 是 "Smart"。
`apply_ratio_logic` 会计算 977 的比例 (0.636)。
**如果 Smart 判定为了 21:9 (2.33)？** 不可能。
**如果 Smart 判定为了 4:3 (1.33)？** 不可能。
**如果 Smart 判定为了 1:1 (1.0)？** 不可能。
**如果 Smart 判定失败？**
代码里 `min(..., key=...)` 总会返回一个值。

**让我怀疑人生一下：**
**用户的 `crop_w` 是 977。**
**用户的 `crop_h` 是 1536。**
**用户的 `padding` 是 20。**
**`RatioCropNode.crop` 里有 padding 逻辑！**
```python
                if use_mask_bbox and mask_bbox:
                    # ... apply padding ...
                    final_w = bw + pad * 2
```
**如果 `use_mask_bbox` 为 True！**
这意味着代码认为用户没有手动设置尺寸。
**但是用户明明设置了 977！**
我在代码里写了：
```python
                        if crop_w <= 1 and crop_h <= 1:
                            use_mask_bbox = True
                        elif crop_x == 0 and crop_y == 0 and crop_w == 512 and crop_h == 512:
                             use_mask_bbox = True
```
用户是 977。所以 `use_mask_bbox` 应该是 False。
所以 padding 逻辑不执行。
`final_w` 初始为 977。

**然后进入 `Force Apply Ratio Logic`。**
`apply_ratio_logic(..., 977, 1536, ..., "Smart")`。
返回 864。
`final_w` 变为 864。

**然后 `core_crop_logic(..., 864, ...)`。**
`core_crop_logic` 内部再次 `apply_ratio_logic(..., 864, 1536, ..., "Smart")`。
864 / 1536 = 0.5625 (9:16)。
Smart 检测为 9:16。
返回 864。
裁切 864。

**这一套逻辑完美无缺。**
**为什么绿框是 977？**
**除非 `RatioCropNode` 里的 `apply_ratio_logic` 没有被调用！**
或者 `ratio` 在 `RatioCropNode` 里是 `Free`，但在 `core_crop_logic` 里不是？
**绝无可能。**

**那就是我修改代码的时候，没把 `RatioCropNode` 里的 `Force Apply Ratio Logic` 加进去？**
或者加错了位置？
**我要 Read 文件！**

**别急，还有一个可能性。**
**用户说“还是对不上”。**
**也许他重启了 ComfyUI，但是我的代码没有保存成功？**
Trae 总是保存成功的。

**让我们看看 `nodes.py` 的第 346 行附近。**
确认 `Force Apply Ratio Logic` 是否存在。

**如果存在，那我只能增加 Debug Print，让用户运行并看控制台了。**
不，我不能让用户看控制台。
**我要把 Debug 信息画在图上！**
在绿框旁边写上 `Ratio: Smart, W: {final_w}`。

**等等，用户之前的截图里，`crop_x` 是 1130。**
**现在的截图里，`crop_x` 是 1112。**
**`crop_w` 从 983 变成了 977。**
**这说明参数变了。**
**变了说明用户动了？或者 Mask 变了？**
如果 Mask 变了，说明 `use_mask_bbox` 生效了？
如果 `use_mask_bbox` 生效了，那 `final_w` 就不是 977，而是 Mask 宽 + padding。
如果 Mask 宽 + padding = 977。
那 `apply_ratio_logic` 应该把它变成 864。

**我已经没有逻辑推断空间了。必须看代码。**
**我要读取 `nodes.py`。**

