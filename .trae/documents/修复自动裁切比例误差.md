# 修复自动裁切比例与输出不一致的方案

用户指出自动裁切（Smart 模式）判断为 9:16，但实际输出的图片宽度有约 20 像素的误差。这通常是因为裁切框在尝试匹配比例时，触碰到了图片边缘（如高度已达极限），导致一边被强制截断，从而破坏了宽高比。

## 修复逻辑
我将修改 `nodes.py` 中 `RatioCropNode` 的 `crop` 方法，在现有的 "Expand"（扩展以包含 Mask）和 "Clamp"（边界截断）逻辑之后，增加一步 **"强制比例修正" (Aspect Ratio Enforcement)**。

具体步骤如下：

1.  **保持现有逻辑**：先尝试根据 Mask 扩展框的大小以匹配目标比例（这能保证 Mask 内容尽量被包含）。
2.  **保持现有逻辑**：将扩展后的框限制在图片边界内（Clamp），防止越界。
3.  **新增逻辑 - 比例回退 (Shrink to Fit)**：
    -   在 Clamp 之后，再次检查当前的宽高比。
    -   如果因为 Clamp 导致比例失真（例如高度被截断了，导致框变“胖”了），则**反向缩小**另一个维度（缩小宽度）。
    -   计算公式：
        -   如果当前比例 > 目标比例（太胖）：`宽度 = 高度 * 目标比例`
        -   如果当前比例 < 目标比例（太瘦）：`高度 = 宽度 / 目标比例`
    -   **居中修正**：在缩小尺寸时，确保围绕中心点进行缩放，避免只裁切掉单侧的内容。
4.  **精度优化**：使用 `round()` 替代 `int()` 进行坐标计算，减少 1px 的舍入误差。

## 预期效果
以用户的案例为例（图片高 1536，目标 9:16）：
-   原逻辑：计算出需要高度 1742 -> 被截断回 1536 -> 输出 980x1536 (比例不准)。
-   新逻辑：计算出需要高度 1742 -> 被截断回 1536 -> **检测到比例不对 -> 将宽度从 980 缩小到 864 (1536 * 9/16)** -> 输出 864x1536 (精准 9:16)。

这样可以确保无论图片尺寸如何，只要设定了比例（Smart 或固定），输出的图片绝对符合该比例，误差控制在 1px 以内。
