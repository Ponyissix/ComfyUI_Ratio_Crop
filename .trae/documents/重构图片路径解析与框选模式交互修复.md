# 终极修复方案：画笔修复、路径解析与框选修正

用户反馈了三个关键问题：
1.  **画笔问题**：依然有“画不上去”的死点，且**透明度会变化**（这是关键新线索，说明 Canvas 混合模式或叠加逻辑有问题）。
2.  **粘贴图片**：之前的修复未完全解决路径问题。
3.  **框选模式**：交互失效。

## 深度分析

### 1. 画笔为什么会变透明？
用户说“没有设置透明度”，但在代码中我之前设置了：
```javascript
maskCtx.strokeStyle = "rgba(255, 0, 0, 0.5)"; // 半透明红色
```
**问题在于叠加**：当你在同一个地方反复涂抹时，半透明颜色会叠加，导致颜色越来越深（看起来像透明度变化）。
更糟糕的是，如果 `globalCompositeOperation` 设置不当，或者在 `draw()` 时候不仅画了 `maskCanvas` 还画了别的，视觉上就会非常混乱。
**修复方案**：
*   **Mask Canvas 应该只存储数据**：在 `maskCanvas` 上绘制时，应该使用 **100% 不透明** 的颜色（如纯红 `rgba(255, 0, 0, 1)`）。
*   **视觉半透明**：在 `draw()` 函数将 `maskCanvas` 绘制到屏幕上时，通过 `ctx.globalAlpha = 0.5` 来实现视觉上的半透明，而不是让 mask 本身半透明。这样无论用户涂多少次，mask 本身都是实心的，视觉上也均匀。
*   **断触问题**：依然是 `getImgPos` 的边界问题，或者是 `scale` 导致的像素对齐问题。我将强制取整并增加 `0.5` 的像素偏移尝试。

### 2. 粘贴图片路径解析
需要实现完整的 ComfyUI 路径解析逻辑：
*   拆分 `subfolder`。
*   全排列尝试 `input/output/temp`。

### 3. 框选模式
*   确保 `mousemove` 逻辑正确处理负宽高。
*   确保 `confirm` 时正确将框转换为 Mask。

## 实施计划

### 1. 彻底重构画笔逻辑 (js/crop_ui.js)
*   **Mask 绘制**：`maskCtx.strokeStyle = "rgba(255, 0, 0, 1)"` (纯色)。
*   **橡皮擦**：`destination-out`。
*   **预览绘制 (`draw`)**：
    ```javascript
    ctx.save();
    ctx.globalAlpha = 0.5; // 统一半透明
    ctx.drawImage(maskCanvas, 0, 0);
    ctx.restore();
    ```
    这样用户看到的是半透明红，但实际 mask 是实心红。
*   **坐标修正**：优化 `getImgPos`，使用 `Math.round` 替代 `Math.floor` 尝试解决边缘偏差。

### 2. 重构图片加载 (`loadImage`)
*   引入 `splitPath` 函数。
*   重试队列：`[temp, input, output]` * `[有subfolder, 无subfolder]`。

### 3. 修正框选交互
*   在 `mousemove` 中标准化 `crop` (x, y, w, h)。
*   在 `confirm` 中，如果 `toolMode === 'box'`，用纯色填充 `crop` 区域到 `maskCanvas`。

请确认执行。